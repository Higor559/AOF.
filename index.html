<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Not√≠cias Esportivas - Home</title>
  <style>
    /* ===== Reset & base ===== */
    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; padding:0; font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif; background:#04060a; color:#e6f0ff; -webkit-font-smoothing:antialiased; }
    a { color:inherit; text-decoration:none; }

    /* ===== Layout ===== */
    header {
      display:flex; align-items:center; justify-content:space-between;
      padding:18px 28px; gap:16px;
      background:linear-gradient(180deg,#071224 0%, #041220 100%);
      border-bottom:1px solid rgba(255,255,255,0.04);
      position:sticky; top:0; z-index:50;
    }
    .brand { display:flex; gap:12px; align-items:center; }
    .logo {
      width:48px; height:48px; border-radius:8px;
      background:linear-gradient(135deg,#0ea5ff,#005fcb);
      display:flex; align-items:center; justify-content:center; font-weight:700;
      box-shadow:0 6px 18px rgba(4,10,30,0.6);
    }
    h1 { margin:0; font-size:1.15rem; letter-spacing:0.2px; }

    nav { display:flex; gap:12px; align-items:center; }
    .btn {
      background:transparent; border:1px solid rgba(255,255,255,0.06);
      color:#cfeaff; padding:8px 12px; border-radius:8px; cursor:pointer;
      font-weight:600; backdrop-filter: blur(4px);
    }
    .btn.primary {
      background:linear-gradient(90deg,#0059b3,#0077e6);
      border:none; color:white; box-shadow:0 8px 20px rgba(0,80,160,0.25);
    }

    main { max-width:1200px; margin:22px auto; padding:0 18px; display:grid; grid-template-columns: 1fr 360px; gap:20px; align-items:start; }

    /* ===== Left column (content) ===== */
    .panel {
      background: linear-gradient(180deg, rgba(6,18,33,0.45), rgba(4,12,22,0.45));
      border-radius:12px; padding:16px; box-shadow: 0 6px 30px rgba(0,0,0,0.6);
      border:1px solid rgba(255,255,255,0.03);
    }

    /* Carousel (centralizado, com margens laterais) */
    .carousel-wrap { display:flex; justify-content:center; }
    .carousel {
      width: 100%;
      max-width: 900px;
      position:relative; overflow:hidden; border-radius:10px; min-height:160px;
      background:linear-gradient(180deg,#031b2b,#021420);
    }
    .carousel-track { display:flex; transition:transform 0.6s ease; will-change:transform; }
    .carousel-item {
      min-width:100%; padding:18px 20px; display:flex; gap:16px; align-items:center;
    }
    .carousel-image {
      width:220px; height:120px; border-radius:10px; object-fit:cover; flex-shrink:0; box-shadow:0 8px 24px rgba(0,0,0,0.6);
      border:1px solid rgba(255,255,255,0.03);
    }
    .carousel-content h3 { margin:0 0 8px 0; color:#dff3ff; font-size:1.05rem; }
    .carousel-content p { margin:0; color:#bcdff6; opacity:0.9; font-size:0.95rem; max-height:80px; overflow:hidden; }

    .carousel-controls { position:absolute; inset:0; pointer-events:none; display:flex; align-items:center; justify-content:space-between; padding:10px;}
    .carousel-arrow {
      pointer-events:auto; background:rgba(5,10,18,0.5); border:none; color:white; width:36px; height:36px; border-radius:8px;
      display:flex; align-items:center; justify-content:center; cursor:pointer;
      backdrop-filter: blur(4px);
    }

    /* News list ‚Äî VERTICAL (uma abaixo da outra) */
    .news-list { margin-top:18px; display:flex; flex-direction:column; gap:14px; }
    .news-row {
      background:linear-gradient(180deg, rgba(4,12,22,0.45), rgba(2,8,18,0.45));
      border-radius:10px; padding:12px; display:flex; gap:12px; align-items:flex-start; cursor:pointer;
      border:1px solid rgba(255,255,255,0.03);
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .news-row:hover { transform:translateY(-6px); box-shadow:0 18px 40px rgba(0,0,0,0.6); }
    .news-thumb { width:160px; height:96px; border-radius:8px; object-fit:cover; flex-shrink:0; border:1px solid rgba(255,255,255,0.03); }
    .news-meta h4 { margin:0; color:#e6f6ff; font-size:1.05rem; }
    .news-meta p { margin:6px 0 0 0; color:#b7d8ff; font-size:0.95rem; opacity:0.95; }
    .news-tags { margin-top:8px; display:flex; gap:6px; flex-wrap:wrap; }
    .tag-pill { background:rgba(0,84,165,0.12); color:#e0f7ff; padding:4px 8px; border-radius:999px; font-size:0.8rem; border:1px solid rgba(0,150,220,0.06); }

    /* Detail view em tela cheia (fundo s√≥lido escuro) */
    #detailView {
      display:none;
    }
    #detailView.fullscreen {
      position:fixed;
      inset:0;
      z-index:9999;
      background: #04060a;
      overflow-y:auto;
      padding:40px 24px;
      display:block;
    }
    #detailCard {
      max-width:1000px; margin:0 auto; background:transparent; border-radius:10px; color:#eaf8ff;
    }
    #detailCard h2 { margin-top:0; color:#e8f8ff; }
    #detailCard .detail-meta { color:#9fcff6; margin-bottom:12px; }
    #detailCard img { width:100%; max-height:520px; object-fit:cover; border-radius:10px; margin:12px 0; border:1px solid rgba(255,255,255,0.03); }

    #backToList { margin-bottom:12px; }

    /* ===== Right column (sidebar) ===== */
    aside { display:flex; flex-direction:column; gap:16px; }

    .tags-list { display:flex; flex-wrap:wrap; gap:8px; }
    .tag-btn {
      background:transparent; border:1px solid rgba(255,255,255,0.04); padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:600;
    }
    .tag-btn.active { background:linear-gradient(90deg,#0059b3,#0077e6); color:white; border:none; box-shadow:0 8px 22px rgba(0,90,180,0.18); }

    .searchbox { display:flex; gap:8px; align-items:center; }
    .searchbox input { flex:1; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:#021020; color:#cfeaff; }

    .editor-panel { display:none; flex-direction:column; gap:10px; }
    .field { display:flex; flex-direction:column; gap:6px; }
    .field input[type="text"], .field textarea, .field select, .field input[type="url"] {
      padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:#021726; color:#dff6ff;
    }
    .field textarea { min-height:110px; resize:vertical; }

    .editor-actions { display:flex; gap:8px; justify-content:flex-end; }

    /* small screens */
    @media (max-width:980px) {
      main { grid-template-columns: 1fr; padding:16px; }
      .news-row { flex-direction:column; align-items:flex-start; }
      .news-thumb { width:100%; height:200px; }
      aside { order:-1; }
      #detailView.fullscreen { padding:18px; }
    }
  </style>
</head>
<body>

  <header>
    <div class="brand">
      <div class="logo">AOF</div>
      <div>
        <h1>ABACATANDO O FUTEBOL</h1>
        <div style="font-size:0.8rem;color:#9fcff6;margin-top:2px;">Painel de not√≠cias ‚Ä¢ Tema escuro</div>
      </div>
    </div>

    <nav>
      <button class="btn" id="allTagsBtn">Todas as Tags</button>
      <button class="btn" id="editorToggleBtn"> Editor</button>
      <button class="btn primary" id="newPostBtn" title="Adicionar nova not√≠cia">+ Nova Not√≠cia</button>
    </nav>
  </header>

  <main>
    <!-- LEFT: content -->
    <section>
      <div class="panel">
        <!-- CAROUSEL: not√≠cias importantes (centralizado) -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <h2 style="margin:0;color:#dff3ff;">Destaques</h2>
          <small style="color:#9fcff6;">carrossel autom√°tico</small>
        </div>

        <div class="carousel-wrap">
          <div class="carousel" id="carousel">
            <div class="carousel-track" id="carouselTrack"></div>
            <div class="carousel-controls">
              <button id="prevSlide" class="carousel-arrow" aria-label="Anterior">‚ùÆ</button>
              <button id="nextSlide" class="carousel-arrow" aria-label="Pr√≥ximo">‚ùØ</button>
            </div>
          </div>
        </div>

        <!-- Lista de not√≠cias (vertical) -->
        <div style="display:flex; justify-content:space-between; align-items:end; margin-top:16px;">
          <h3 style="margin:0;color:#dff3ff;">√öltimas Not√≠cias</h3>
          <div style="color:#9fcff6;font-size:0.95rem;" id="currentFilterLabel">Todas</div>
        </div>

        <div class="news-list" id="newsList" style="margin-top:12px;"></div>
      </div>

      <!-- Detalhe da not√≠cia (vis√≠vel quando abrir uma not√≠cia) -->
      <div id="detailView">
        <div id="detailCard">
          <div style="display:flex; justify-content:flex-start; gap:8px; margin-bottom:12px;">
            <button class="btn" id="backToList">‚Üê Voltar</button>
          </div>
          <div id="detailContent" style="background:transparent; padding:12px; border-radius:8px;"></div>
        </div>
      </div>
    </section>

    <!-- RIGHT: sidebar -->
    <aside>
      <div class="panel">
        <h4 style="margin:0 0 8px 0;color:#dff3ff;">Buscar</h4>
        <div class="searchbox">
          <input type="text" id="searchInput" placeholder="Pesquisar por t√≠tulo ou tag..." />
          <button class="btn" id="searchBtn">üîç</button>
        </div>

        <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03); margin:12px 0;">

        <h4 style="margin:0 0 8px 0;color:#dff3ff;">Tags</h4>
        <div class="tags-list" id="tagsList"></div>

        <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03); margin:12px 0;">

        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div style="font-weight:700;color:#cfeaff;">Editor</div>
          <div style="font-size:0.85rem;color:#9fcff6">protegido</div>
        </div>

        <div id="editorPanel" class="editor-panel" style="margin-top:10px;">
          <div class="field">
            <label style="font-weight:700;color:#cfeaff;">T√≠tulo</label>
            <input type="text" id="editorTitle" placeholder="T√≠tulo da not√≠cia">
          </div>

          <div class="field">
            <label style="font-weight:700;color:#cfeaff;">Tema (tag fixa)</label>
            <select id="editorTag"></select>
          </div>

          <div class="field">
            <label style="font-weight:700;color:#cfeaff;">Imagem (URL)</label>
            <input type="url" id="editorImageUrl" placeholder="Cole o link da imagem (recomendado)">
          </div>

          <div class="field">
            <label style="font-weight:700;color:#cfeaff;">Ou envie do dispositivo (opcional)</label>
            <input type="file" id="editorImageFile" accept="image/*">
          </div>

          <div class="field">
            <label style="font-weight:700;color:#cfeaff;">Conte√∫do</label>
            <textarea id="editorContent" placeholder="Conte√∫do da not√≠cia..."></textarea>
          </div>

          <div style="display:flex;gap:8px;align-items:center;">
            <input type="checkbox" id="editorImportant">
            <label for="editorImportant" style="margin:0;color:#9fcff6;">Marcar como importante (aparece no carrossel)</label>
          </div>

          <div class="editor-actions">
            <button class="btn" id="cancelEdit">Cancelar</button>
            <button class="btn primary" id="saveNewsBtn">Salvar Not√≠cia</button>
          </div>

          <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03); margin:12px 0;">

          <h4 style="margin:0 0 8px 0;color:#dff3ff;">Not√≠cias Cadastradas</h4>
          <div id="editorNewsList" style="display:flex;flex-direction:column;gap:8px;max-height:240px;overflow:auto;"></div>
        </div>
      </div>

      <div class="panel" style="text-align:center; font-size:0.9rem; color:#9fcff6;">
        <div style="font-weight:700; margin-bottom:8px;">Dica</div>
        Use o bot√£o <strong>+ Nova Not√≠cia</strong> ou o <strong>Modo Editor</strong> 
      </div>
    </aside>
  </main>

<script type="module">
/* ============================
   Firebase (CDN modules)
   ============================ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-analytics.js";
import {
  getFirestore, collection, doc, setDoc, addDoc, getDoc, getDocs, onSnapshot,
  query, orderBy, serverTimestamp, updateDoc, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
import {
  getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-storage.js";

/* Seu Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyB4OI3ztWRTYyUahJ9PKmzSpRkFvD9p73s",
  authDomain: "aofweb-8ece3.firebaseapp.com",
  projectId: "aofweb-8ece3",
  storageBucket: "aofweb-8ece3.firebasestorage.app",
  messagingSenderId: "141492852619",
  appId: "1:141492852619:web:939b08282d56fc13fe018e",
  measurementId: "G-L1PCBJ05GC"
};

const firebaseApp = initializeApp(firebaseConfig);
const analytics = getAnalytics(firebaseApp);
const db = getFirestore(firebaseApp);
const storage = getStorage(firebaseApp);

/* ============================
   Configura√ß√µes iniciais
   ============================ */
const FIXED_TAGS = [
  "Champions",
  "Brasileir√£o",
  "Premier League",
  "Bundesliga",
  "Copas",
  "Libertadores",
  "La Liga",
  "Serie A"
];
const ADMIN_PASSWORD = "admin123";
const AUTO_CAROUSEL_INTERVAL = 4000;

/* DOM */
const carouselTrack = document.getElementById('carouselTrack');
const prevSlideBtn = document.getElementById('prevSlide');
const nextSlideBtn = document.getElementById('nextSlide');
const newsList = document.getElementById('newsList');
const tagsList = document.getElementById('tagsList');
const editorToggleBtn = document.getElementById('editorToggleBtn');
const editorPanel = document.getElementById('editorPanel');
const editorNewsList = document.getElementById('editorNewsList');
const editorTagSelect = document.getElementById('editorTag');
const saveNewsBtn = document.getElementById('saveNewsBtn');
const cancelEditBtn = document.getElementById('cancelEdit');
const newPostBtn = document.getElementById('newPostBtn');
const allTagsBtn = document.getElementById('allTagsBtn');
const currentFilterLabel = document.getElementById('currentFilterLabel');
const detailView = document.getElementById('detailView');
const detailContent = document.getElementById('detailContent');
const backToListBtn = document.getElementById('backToList');
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const editorImageFile = document.getElementById('editorImageFile');

const editorTitle = document.getElementById('editorTitle');
const editorImageUrl = document.getElementById('editorImageUrl');
const editorContent = document.getElementById('editorContent');
const editorImportant = document.getElementById('editorImportant');

let newsArray = [];
let filteredTag = null;
let carouselIndex = 0;
let carouselTimer = null;
let isAuthenticated = false;

/* ============================
   UI init
   ============================ */
function initTagsUI() {
  tagsList.innerHTML = '';
  FIXED_TAGS.forEach(tag => {
    const btn = document.createElement('button');
    btn.className = 'tag-btn';
    btn.textContent = tag;
    btn.addEventListener('click', () => setFilterByTag(tag));
    tagsList.appendChild(btn);
  });
  allTagsBtn.addEventListener('click', () => setFilterByTag(null));
  editorTagSelect.innerHTML = `<option value="" disabled selected>Selecione uma tag</option>` +
    FIXED_TAGS.map(t => `<option value="${t}">${t}</option>`).join('');
}
initTagsUI();

/* ============================
   Firestore listener (realtime)
   ============================ */
const newsCollection = collection(db, 'news');
const newsQuery = query(newsCollection, orderBy('createdAt', 'desc'));
onSnapshot(newsQuery, (snapshot) => {
  newsArray = snapshot.docs.map(docSnap => {
    const d = docSnap.data();
    const createdAt = d && d.createdAt && typeof d.createdAt.toMillis === 'function'
      ? d.createdAt.toMillis()
      : (d.createdAt || Date.now());
    return {
      id: docSnap.id,
      title: d.title || '',
      theme: d.theme || '',
      image: d.image || '',
      imagePath: d.imagePath || null,
      content: d.content || '',
      tags: d.tags || [],
      isImportant: !!d.isImportant,
      createdAt
    };
  });
  renderAll();
}, (err) => {
  console.error('Erro ao receber not√≠cias do Firestore:', err);
});

/* ============================
   Render functions
   ============================ */
function renderCarousel() {
  const important = newsArray.filter(n => n.isImportant);
  if (important.length === 0) {
    carouselTrack.innerHTML = `<div style="padding:28px;color:#9fcff6;">Nenhuma not√≠cia destacada.</div>`;
    return;
  }
  carouselTrack.innerHTML = '';
  important.forEach((n) => {
    const item = document.createElement('div');
    item.className = 'carousel-item';
    item.innerHTML = `
      <img class="carousel-image" src="${n.image || ''}" alt="" onerror="this.style.display='none'">
      <div class="carousel-content">
        <div style="font-size:0.9rem;color:#88d0ff;margin-bottom:6px;">${n.theme}</div>
        <h3>${escapeHtml(n.title)}</h3>
        <p>${truncateText(stripHtml(n.content), 200)}</p>
      </div>
    `;
    item.addEventListener('click', () => openDetailById(n.id));
    carouselTrack.appendChild(item);
  });
  if (carouselIndex >= important.length) carouselIndex = 0;
  updateCarouselPosition();
  startCarouselAuto();
}
function updateCarouselPosition() { carouselTrack.style.transform = `translateX(-${carouselIndex * 100}%)`; }
function startCarouselAuto() {
  stopCarouselAuto();
  carouselTimer = setInterval(() => {
    const important = newsArray.filter(n => n.isImportant);
    if (important.length <= 1) return;
    carouselIndex = (carouselIndex + 1) % important.length;
    updateCarouselPosition();
  }, AUTO_CAROUSEL_INTERVAL);
}
function stopCarouselAuto() { if (carouselTimer) { clearInterval(carouselTimer); carouselTimer = null; } }

nextSlideBtn.addEventListener('click', () => {
  const important = newsArray.filter(n => n.isImportant);
  if (important.length <= 1) return;
  carouselIndex = (carouselIndex + 1) % important.length;
  updateCarouselPosition();
  startCarouselAuto();
});
prevSlideBtn.addEventListener('click', () => {
  const important = newsArray.filter(n => n.isImportant);
  if (important.length <= 1) return;
  carouselIndex = (carouselIndex - 1 + important.length) % important.length;
  updateCarouselPosition();
  startCarouselAuto();
});
document.getElementById('carousel').addEventListener('mouseenter', stopCarouselAuto);
document.getElementById('carousel').addEventListener('mouseleave', startCarouselAuto);

function renderNewsList() {
  const q = (searchInput.value || '').trim().toLowerCase();
  let visible = newsArray.slice();
  if (filteredTag) visible = visible.filter(n => n.theme === filteredTag);
  if (q) {
    visible = visible.filter(n => (n.title && n.title.toLowerCase().includes(q)) ||
                                  (n.tags && n.tags.join(' ').toLowerCase().includes(q)) ||
                                  (n.content && n.content.toLowerCase().includes(q)));
  }
  visible.sort((a,b) => {
    if (a.isImportant && !b.isImportant) return -1;
    if (!a.isImportant && b.isImportant) return 1;
    return b.createdAt - a.createdAt;
  });
  newsList.innerHTML = '';
  if (!visible.length) {
    newsList.innerHTML = `<div style="color:#9fcff6">Nenhuma not√≠cia encontrada.</div>`;
    return;
  }
  visible.forEach(n => {
    const row = document.createElement('div');
    row.className = 'news-row';
    row.innerHTML = `
      ${n.image ? `<img class="news-thumb" src="${n.image}" onerror="this.style.display='none'">` : `<div style="width:160px;height:96px;border-radius:8px;background:linear-gradient(90deg,#071826,#022535);display:flex;align-items:center;justify-content:center;color:#7fbff7;border:1px solid rgba(255,255,255,0.02)">SEM IMG</div>`}
      <div class="news-meta" style="flex:1">
        <h4>${escapeHtml(n.title)}</h4>
        <div style="font-size:0.9rem;color:#9fcff6;margin-top:6px;">${n.theme} ‚Ä¢ ${formatDate(n.createdAt)}</div>
        <p style="margin-top:8px;color:#bfe9ff;opacity:0.95;">${truncateText(stripHtml(n.content), 180)}</p>
        <div class="news-tags">${(n.tags || []).map(t => `<span class="tag-pill">#${t}</span>`).join('')}</div>
      </div>
    `;
    row.addEventListener('click', () => openDetailById(n.id));
    newsList.appendChild(row);
  });
}

function renderEditorNewsList() {
  editorNewsList.innerHTML = '';
  if (!newsArray.length) {
    editorNewsList.innerHTML = `<div style="color:#9fcff6">Nenhuma not√≠cia cadastrada.</div>`;
    return;
  }
  newsArray.forEach(n => {
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.justifyContent = 'space-between';
    row.style.alignItems = 'center';
    row.style.padding = '6px';
    row.style.borderRadius = '6px';
    row.style.border = '1px solid rgba(255,255,255,0.02)';
    row.style.background = 'linear-gradient(180deg, rgba(3,8,14,0.12), rgba(2,6,10,0.08))';

    const left = document.createElement('div');
    left.innerHTML = `<div style="font-weight:700;color:#dff3ff">${escapeHtml(n.title)}</div><div style="font-size:0.85rem;color:#9fcff6">${n.theme} ‚Ä¢ ${formatDate(n.createdAt)}</div>`;

    const actions = document.createElement('div');
    actions.style.display = 'flex';
    actions.style.gap = '8px';

    const editBtn = document.createElement('button');
    editBtn.className = 'btn';
    editBtn.textContent = 'Editar';
    editBtn.addEventListener('click', () => openEditorForEdit(n.id));

    const delBtn = document.createElement('button');
    delBtn.className = 'btn';
    delBtn.style.background = '#b51b1b';
    delBtn.style.color = 'white';
    delBtn.textContent = 'Excluir';
    delBtn.addEventListener('click', () => {
      if (confirm('Deseja realmente excluir esta not√≠cia?')) {
        deleteNewsById(n.id, n.imagePath);
      }
    });

    actions.appendChild(editBtn);
    actions.appendChild(delBtn);
    row.appendChild(left);
    row.appendChild(actions);
    editorNewsList.appendChild(row);
  });
}

/* ============================
   Filtrar por tag
   ============================ */
function setFilterByTag(tag) {
  filteredTag = tag;
  currentFilterLabel.textContent = tag || 'Todas';
  Array.from(document.querySelectorAll('.tag-btn')).forEach(btn => {
    btn.classList.toggle('active', btn.textContent.startsWith(tag || ''));
  });
  allTagsBtn.classList.toggle('active', !tag);
  renderNewsList();
}

/* ============================
   Editor: autentica√ß√£o e UI
   ============================ */
editorToggleBtn.addEventListener('click', () => {
  const pwd = prompt('Digite a senha do editor:');
  if (pwd === null) return;
  if (pwd === ADMIN_PASSWORD) {
    isAuthenticated = true;
    editorPanel.style.display = 'flex';
    editorPanel.scrollIntoView({behavior:'smooth', block:'center'});
    renderEditorNewsList();
    renderAll();
    alert('Editor desbloqueado.');
  } else {
    alert('Senha incorreta.');
  }
});

newPostBtn.addEventListener('click', () => {
  if (!isAuthenticated) {
    editorToggleBtn.click();
    setTimeout(() => openEditorForNew(), 250);
  } else openEditorForNew();
});

function openEditorForNew() {
  editorTitle.value = '';
  editorImageUrl.value = '';
  editorContent.value = '';
  editorImportant.checked = false;
  editorTagSelect.value = '';
  editorImageFile.value = '';
  editorPanel.style.display = 'flex';
}

/* ============================
   Save (create) news
   ============================ */
saveNewsBtn.addEventListener('click', async (e) => {
  e.preventDefault();
  if (!isAuthenticated) {
    alert('Voc√™ precisa ativar o modo editor com a senha.');
    return;
  }

  const title = (editorTitle.value || '').trim();
  const theme = (editorTagSelect.value || '').trim();
  const content = (editorContent.value || '').trim();
  const isImportant = !!editorImportant.checked;
  const imageUrlInput = editorImageUrl.value.trim();
  const file = editorImageFile.files && editorImageFile.files[0];

  if (!title || !theme || !content) {
    alert('Preencha t√≠tulo, tema e conte√∫do.');
    return;
  }

  // gerar id para facilitar path da imagem
  const id = generateId();
  let finalImageUrl = imageUrlInput || '';
  let imagePath = null;

  if (file) {
    try {
      const safeName = `${id}_${file.name.replace(/\s+/g,'_')}`;
      const storageReference = storageRef(storage, `newsImages/${safeName}`);
      await uploadBytes(storageReference, file);
      finalImageUrl = await getDownloadURL(storageReference);
      imagePath = storageReference.fullPath;
    } catch (err) {
      console.error('Erro upload imagem:', err);
      finalImageUrl = imageUrlInput || '';
      imagePath = null;
    }
  }

  const newsItem = {
    title,
    theme,
    image: finalImageUrl || '',
    imagePath: imagePath || null,
    content,
    tags: [theme],
    isImportant,
    createdAt: serverTimestamp()
  };

  try {
    // usa setDoc com id gerado para manter consist√™ncia
    await setDoc(doc(db, 'news', id), newsItem);
    alert('Not√≠cia salva!');
    openEditorForNew();
    // onSnapshot atualiza a lista automaticamente
  } catch (err) {
    console.error('Erro ao salvar not√≠cia:', err);
    alert('Erro ao salvar not√≠cia. Veja console.');
  }
});

/* ============================
   Editar not√≠cia (preenche formul√°rio e atualiza)
   ============================ */
async function openEditorForEdit(id) {
  try {
    const dRef = doc(db, 'news', id);
    const snap = await getDoc(dRef);
    if (!snap.exists()) return alert('Not√≠cia n√£o encontrada.');
    const d = snap.data();
    editorTitle.value = d.title || '';
    editorTagSelect.value = d.theme || '';
    editorImageUrl.value = d.image || '';
    editorContent.value = d.content || '';
    editorImportant.checked = !!d.isImportant;
    editorImageFile.value = '';
  } catch (err) {
    console.error('Erro ao abrir edi√ß√£o:', err);
    alert('Erro ao abrir edi√ß√£o. Veja console.');
    return;
  }

  // override do bot√£o salvar para atualizar
  const originalHandler = saveNewsBtn.onclick;
  saveNewsBtn.onclick = async (ev) => {
    ev.preventDefault();
    const title = (editorTitle.value || '').trim();
    const theme = (editorTagSelect.value || '').trim();
    const content = (editorContent.value || '').trim();
    if (!title || !theme || !content) {
      alert('Preencha t√≠tulo, tema e conte√∫do.');
      return;
    }
    const file = editorImageFile.files && editorImageFile.files[0];

    try {
      const dRef = doc(db, 'news', ev.target.dataset.editId || null);
      // But we need the actual id ‚Äî we'll instead capture id via closure:
    } catch (e) {
      // noop
    }
  };

  // simpler approach: create a dedicated update flow with captured id
  const idToEdit = id;

  // temporary handler
  const tempHandler = async (ev) => {
    ev.preventDefault();
    const title = (editorTitle.value || '').trim();
    const theme = (editorTagSelect.value || '').trim();
    const content = (editorContent.value || '').trim();
    const isImportantVal = !!editorImportant.checked;
    const file2 = editorImageFile.files && editorImageFile.files[0];

    if (!title || !theme || !content) {
      alert('Preencha t√≠tulo, tema e conte√∫do.');
      return;
    }

    // fetch current doc to know previous imagePath
    const dRef = doc(db, 'news', idToEdit);
    let current = {};
    try {
      const snap = await getDoc(dRef);
      if (snap.exists()) current = snap.data();
    } catch (err) {
      console.warn('N√£o foi poss√≠vel buscar documento atual:', err);
    }

    let finalImageUrl = current.image || editorImageUrl.value.trim() || '';
    let imagePath = current.imagePath || null;

    if (file2) {
      try {
        const safeName = `${idToEdit}_${file2.name.replace(/\s+/g,'_')}`;
        const storageReference = storageRef(storage, `newsImages/${safeName}`);
        await uploadBytes(storageReference, file2);
        finalImageUrl = await getDownloadURL(storageReference);
        const newPath = storageReference.fullPath;
        // delete old image if existed
        if (imagePath) {
          try { await deleteObject(storageRef(storage, imagePath)); } catch (e) { console.warn('N√£o foi poss√≠vel deletar imagem antiga:', e); }
        }
        imagePath = newPath;
      } catch (err) {
        console.error('Erro upload imagem na edi√ß√£o:', err);
        alert('Erro ao enviar imagem. Mantendo imagem anterior ou URL informado.');
      }
    } else {
      finalImageUrl = editorImageUrl.value.trim() || finalImageUrl;
    }

    try {
      await updateDoc(doc(db, 'news', idToEdit), {
        title,
        theme,
        content,
        image: finalImageUrl || '',
        imagePath: imagePath || null,
        tags: [theme],
        isImportant: isImportantVal
      });
      alert('Not√≠cia atualizada!');
      saveNewsBtn.removeEventListener('click', tempHandler);
      // restaura listener padr√£o (rebind novo listener)
      bindSaveListenerDefault();
      openEditorForNew();
    } catch (err) {
      console.error('Erro ao atualizar:', err);
      alert('Erro ao atualizar not√≠cia. Veja console.');
    }
  };

  // remove any previous temp handlers to avoid duplicates, then attach
  saveNewsBtn.removeEventListener('click', tempHandler);
  saveNewsBtn.addEventListener('click', tempHandler);
}

/* helper to rebind default save (in case overwritten) */
function bindSaveListenerDefault() {
  // remove all listeners by cloning button
  const newBtn = saveNewsBtn.cloneNode(true);
  saveNewsBtn.parentNode.replaceChild(newBtn, saveNewsBtn);
  // reassign references
  window.saveNewsBtn = document.getElementById('saveNewsBtn');
  // attach default handler
  window.saveNewsBtn.addEventListener('click', async (e) => {
    e.preventDefault();
    if (!isAuthenticated) { alert('Voc√™ precisa ativar o modo editor com a senha.'); return; }
    const title = (editorTitle.value || '').trim();
    const theme = (editorTagSelect.value || '').trim();
    const content = (editorContent.value || '').trim();
    const isImportant = !!editorImportant.checked;
    const imageUrlInput = editorImageUrl.value.trim();
    const file = editorImageFile.files && editorImageFile.files[0];
    if (!title || !theme || !content) { alert('Preencha t√≠tulo, tema e conte√∫do.'); return; }
    const id = generateId();
    let finalImageUrl = imageUrlInput || '';
    let imagePath = null;
    if (file) {
      try {
        const safeName = `${id}_${file.name.replace(/\s+/g,'_')}`;
        const storageReference = storageRef(storage, `newsImages/${safeName}`);
        await uploadBytes(storageReference, file);
        finalImageUrl = await getDownloadURL(storageReference);
        imagePath = storageReference.fullPath;
      } catch (err) {
        console.error('Erro upload imagem:', err);
        finalImageUrl = imageUrlInput || '';
        imagePath = null;
      }
    }
    try {
      await setDoc(doc(db, 'news', id), {
        title, theme, image: finalImageUrl || '', imagePath: imagePath || null,
        content, tags: [theme], isImportant, createdAt: serverTimestamp()
      });
      alert('Not√≠cia salva!');
      openEditorForNew();
    } catch (err) {
      console.error('Erro ao salvar not√≠cia:', err);
      alert('Erro ao salvar not√≠cia. Veja console.');
    }
  });
}
// bind default on load:
bindSaveListenerDefault();

/* ============================
   Delete (Firestore + Storage)
   ============================ */
async function deleteNewsById(id, imagePath) {
  try {
    if (imagePath) {
      try { await deleteObject(storageRef(storage, imagePath)); } catch (e) { console.warn('Falha deleting storage:', e); }
    }
    await deleteDoc(doc(db, 'news', id));
    alert('Not√≠cia exclu√≠da.');
  } catch (err) {
    console.error('Erro ao excluir not√≠cia:', err);
    alert('Erro ao excluir not√≠cia. Veja console.');
  }
}

/* ============================
   Detalhe & close
   ============================ */
function openDetailById(id) {
  const item = newsArray.find(n => n.id === id);
  if (!item) return alert('Not√≠cia n√£o encontrada.');

  detailView.classList.add('fullscreen');
  detailContent.innerHTML = `
    <div style="background:transparent; padding:18px; border-radius:8px;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
        <div>
          <div style="font-size:0.95rem;color:#88d0ff;margin-bottom:6px;">${item.theme}</div>
          <h2>${escapeHtml(item.title)}</h2>
          <div class="detail-meta">${formatDate(item.createdAt)}</div>
        </div>
        <div style="text-align:right;">
          ${isAuthenticated ? `<button class="btn" id="editThisBtn" style="margin-bottom:6px;">Editar</button>
          <button class="btn" id="deleteThisBtn" style="background:#b30000;color:white;">Excluir</button>` : ''}
        </div>
      </div>
      ${item.image ? `<img src="${item.image}" alt="imagem" onerror="this.style.display='none'">` : ''}
      <div style="color:#dff7ff; white-space:pre-line; margin-top:12px;">${escapeHtmlPreserveNewlines(item.content)}</div>
      <div style="margin-top:12px;">${(item.tags||[]).map(t => `<span class="tag-pill">#${t}</span>`).join('')}</div>
    </div>
  `;

  if (isAuthenticated) {
    const editBtn = document.getElementById('editThisBtn');
    const delBtn = document.getElementById('deleteThisBtn');
    if (editBtn) editBtn.addEventListener('click', () => { editorPanel.style.display = 'flex'; openEditorForEdit(item.id); editorPanel.scrollIntoView({behavior:'smooth', block:'center'}); });
    if (delBtn) delBtn.addEventListener('click', () => { if (confirm('Deseja excluir esta not√≠cia?')) deleteNewsById(item.id, item.imagePath).then(closeDetail); });
  }
  detailView.scrollTop = 0;
}

backToListBtn.addEventListener('click', closeDetail);
function closeDetail() { detailView.classList.remove('fullscreen'); detailContent.innerHTML = ''; document.querySelector('main').scrollIntoView({behavior:'smooth', block:'start'}); }

/* ============================
   Busca e utilit√°rios
   ============================ */
searchBtn.addEventListener('click', () => renderNewsList());
searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') renderNewsList(); });

function renderAll() {
  renderCarousel();
  renderNewsList();
  if (isAuthenticated) renderEditorNewsList();
  renderTagCounts();
}

function renderTagCounts() {
  const counts = {};
  FIXED_TAGS.forEach(t => counts[t] = 0);
  newsArray.forEach(n => { if (n.theme && counts[n.theme] !== undefined) counts[n.theme] += 1; });
  const btns = document.querySelectorAll('.tag-btn');
  btns.forEach(btn => {
    const base = btn.textContent.split(' (')[0];
    const count = counts[base] || 0;
    btn.textContent = `${base} (${count})`;
    btn.classList.toggle('active', filteredTag === base);
  });
}

function formatDate(ts) {
  const d = new Date(ts);
  return `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getFullYear()} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
}

function truncateText(text, n) { if (!text) return ''; return text.length > n ? text.slice(0,n-1) + '‚Ä¶' : text; }
function stripHtml(html) { return (html || '').replace(/<[^>]*>/g, ''); }
function escapeHtml(text) { if (!text) return ''; return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
function escapeHtmlPreserveNewlines(text) { return escapeHtml(text).replace(/\n/g,'<br>'); }
function generateId() { return Date.now().toString(36) + Math.random().toString(36).slice(2,8); }

/* ============================
   Inicializa√ß√£o
   ============================ */
function bootstrap() {
  renderAll();
  allTagsBtn.classList.add('active');
  setFilterByTag(null);
}
bootstrap();

</script>

</body>
</html>
